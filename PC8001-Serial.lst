 AS V1.42 Beta [Bld 180] - Source File PC8001-Serial.asm - Page 1 - 2021/04/17 22時24分04秒


       1/       0 :                     ;
       2/       0 :                     ; PC-8001内蔵シリアルドライバー(割り込みなし)
       3/       0 :                     ;
       4/       0 :                     	CPU	Z80
       5/       0 :                     
       6/       0 : ="Z80"              TARGET:	equ	"Z80"
       7/       0 :                     
       8/       0 : =20H                UARTRD	EQU	20H
       9/       0 : =21H                UARTRC	EQU	21H
      10/       0 :                     ;
      11/       0 : =80H                BUFSIZ	EQU	80H
      12/       0 :                     ;
      13/       0 : =17H                RTSHIG	EQU	00010111B
      14/       0 : =37H                RTSLOW	EQU	00110111B
      15/       0 :                     ;
      16/       0 :                     ;
      17/       0 : =0DH                CR	EQU	0DH
      18/       0 : =0AH                LF	EQU	0AH
      19/       0 :                     ;
      20/    E900 :                         org 0E900h
      21/    E900 :                     ;
      22/    E900 :                     ; 各ルーチンへのエントリーテーブル
      23/    E900 :                     ;
      24/    E900 : C3 0C E9                JP  INIT8251
      25/    E903 : C3 37 E9                JP  SERIAL_READ
      26/    E906 : C3 53 E9                JP  SERIAL_WRITE
      27/    E909 : C3 28 E9                JP  RET_CMT
      28/    E90C :                     ;
      29/    E90C :                     ; 8251 シリアルLSI初期化
      30/    E90C :                     ;
      31/    E90C :                     INIT8251:
      32/    E90C : AF                  	XOR	A
      33/    E90D : D3 21               	OUT	(UARTRC),A
      34/    E90F : D3 21               	OUT	(UARTRC),A
      35/    E911 : D3 21               	OUT	(UARTRC),A
      36/    E913 : 7E                      LD  A,(HL)
      37/    E914 :                     ;	LD	A,01000000B
      38/    E914 : D3 21               	OUT	(UARTRC),A
      39/    E916 : 23                      INC HL
      40/    E917 : 7E                      LD  A,(HL)
      41/    E918 :                     ;	LD	A,01001110B
      42/    E918 : D3 21               	OUT	(UARTRC),A
      43/    E91A : 3E 37               	LD	A,RTSLOW
      44/    E91C : D3 21               	OUT	(UARTRC),A
      45/    E91E :                     ;
      46/    E91E :                     ;  PC-8001の8251を外部RS232Cヘ
      47/    E91E :                     ;
      48/    E91E : 3A 66 EA                LD  A,(0EA66h)  ; ワークエリアから I/O 30hへ出力する情報を取得
      49/    E921 : E6 CF                   AND A,0CFh
      50/    E923 : F6 20                   OR  A,20h      ; BS2 = ON
      51/    E925 : D3 30                   OUT (30h),A    ; CMTから外部RS232Cへ切り替え
      52/    E927 :                     ;
      53/    E927 : C9                      RET
      54/    E928 :                     ;
      55/    E928 :                     ; 8251をCMT側へ戻す
      56/    E928 :                     ;
      57/    E928 :                     RET_CMT:
      58/    E928 : 3A 66 EA                LD  A,(0EA66h)  ; ワークエリアから I/O 30hへ出力する情報を取得
      59/    E92B : E6 CF                   AND A,0CFh
      60/    E92D : D3 30                   OUT (30h),A    ; CMTから外部RS232Cへ切り替え
 AS V1.42 Beta [Bld 180] - Source File PC8001-Serial.asm - Page 2 - 2021/04/17 22時24分04秒


      61/    E92F : C9                      RET
      62/    E930 :                     ;
      63/    E930 :                     ; USR関数から渡ってきたストリングディスクリプタ情報を取得
      64/    E930 :                     ;
      65/    E930 :                     STR_DISC_SETUP:
      66/    E930 : 1A                      LD A,(DE)   ; 文字列長取得
      67/    E931 : 4F                      LD C,A      ; 文字列カウンタはCレジスタ
      68/    E932 : 1A                      LD A,(DE)
      69/    E933 : 6F                      LD L,A
      70/    E934 : 1A                      LD A,(DE)
      71/    E935 : 67                      LD H,A      ; HLレジスタへ文字列ポインタを入れる
      72/    E936 : C9                      RET
      73/    E937 :                     ;
      74/    E937 :                     ; USR関数 シリアル受信(ポーリング)
      75/    E937 :                     ;
      76/    E937 :                     SERIAL_READ:
      77/    E937 : CD 30 E9                CALL STR_DISC_SETUP
      78/    E93A :                     ;
      79/    E93A : 0E 80                   LD C,BUFLEN         ; 入力バッファ長をCレジスタヘ
      80/    E93C :                     SERIAL_READ1:
      81/    E93C : CD 60 E9                CALL CHAR_IN
      82/    E93F : 0D                      DEC C
      83/    E940 : CA 52 E9                JP Z,SERIAL_READ_END ; バッファがいっぱいになったらEXIT
      84/    E943 : FE 0D                   CP CR
      85/    E945 : CA 52 E9                JP Z,SERIAL_READ_END ; CRコードがきたらEXIT
      86/    E948 : FE 0A                   CP LF
      87/    E94A : CA 52 E9                JP Z,SERIAL_READ_END ; LFコードがきたらEXIT
      88/    E94D : 77                      LD  (HL),A
      89/    E94E : 23                      INC HL
      90/    E94F : C3 3C E9                JP  SERIAL_READ1
      91/    E952 :                     SERIAL_READ_END:
      92/    E952 : C9                      RET
      93/    E953 :                     ;
      94/    E953 :                     ; USR関数 シリアル送信
      95/    E953 :                     ;
      96/    E953 :                     SERIAL_WRITE:
      97/    E953 : CD 30 E9                CALL STR_DISC_SETUP;
      98/    E956 :                     SERIAL_WRITE1:
      99/    E956 : 7E                      LD A,(HL)   ; 1文字取得
     100/    E957 : CD 6A E9                CALL CHAR_OUT
     101/    E95A : 23                      INC HL
     102/    E95B : 0D                      DEC C
     103/    E95C : C2 56 E9                JP NZ,SERIAL_WRITE1
     104/    E95F :                     ;
     105/    E95F : C9                      RET
     106/    E960 :                     
     107/    E960 :                     ;
     108/    E960 :                     ; 8251から1文字入力
     109/    E960 :                     ;
     110/    E960 :                     CHAR_IN:
     111/    E960 : DB 21                   IN  A,(UARTRC)
     112/    E962 : E6 02                   AND A,02h
     113/    E964 : CA 60 E9                JP  Z,CHAR_IN
     114/    E967 : DB 20                   IN  A,(UARTRD)
     115/    E969 : C9                      RET
     116/    E96A :                     ;
     117/    E96A :                     ; 8251へ1文字出力
     118/    E96A :                     ;
     119/    E96A :                     CHAR_OUT:
     120/    E96A : F5                      PUSH AF
 AS V1.42 Beta [Bld 180] - Source File PC8001-Serial.asm - Page 3 - 2021/04/17 22時24分04秒


     121/    E96B :                     CHAR_OUT1:
     122/    E96B : DB 21                   IN A,(UARTRC)
     123/    E96D : E6 01                   AND A,01h
     124/    E96F : CA 6B E9                JP  Z,CHAR_OUT1
     125/    E972 : F1                      POP AF
     126/    E973 : D3 20                   OUT (UARTRD),A
     127/    E975 : C9                      RET
     128/    E976 :                     ;
     129/    E976 :                     ;
     130/    E976 :                     ; RAM
     131/    E976 :                     SERBUF	DS	BUFSIZ
     132/    E9F6 : =80H                BUFLEN  EQU $-SERBUF
 AS V1.42 Beta [Bld 180] - Source File PC8001-Serial.asm - Page 4 - 2021/04/17 22時24分04秒


  Symbol Table (* = unused):
  --------------------------

*ARCHITECTURE :  "x86_64-apple-osx" - | *BIGENDIAN :                      0 - |
*BRANCHEXT :                      0 - |  BUFLEN :                        80 - |
 BUFSIZ :                        80 - | *CASESENSITIVE :                  0 - |
 CHAR_IN :                    0E960 C |  CHAR_OUT :                   0E96A C |
 CHAR_OUT1 :                  0E96B C | *CONSTPI :        3.141592653589793 - |
 CR :                            0D - | *DATE :                "2021/04/17" - |
*FALSE :                          0 - | *FULLPMMU :                       1 - |
*HAS64 :                          1 - | *HASDSP :                         0 - |
*HASFPU :                         0 - | *HASPMMU :                        0 - |
*INEXTMODE :                      0 - |  INIT8251 :                   0E90C C |
*INLWORDMODE :                    0 - | *INMAXMODE :                      0 - |
*INSRCMODE :                      0 - | *INSUPMODE :                      0 - |
 LF :                            0A - | *LISTON :                         1 - |
*MACEXP :                         7 - | *MOMCPU :                        80 - |
*MOMCPUNAME :                 "Z80" - | *NESTMAX :                      100 - |
*PACKING :                        0 - | *PADDING :                        1 - |
*RELAXED :                        0 - |  RET_CMT :                    0E928 C |
*RTSHIG :                        17 - |  RTSLOW :                        37 - |
 SERBUF :                     0E976 C |  SERIAL_READ :                0E937 C |
 SERIAL_READ1 :               0E93C C |  SERIAL_READ_END :            0E952 C |
 SERIAL_WRITE :               0E953 C |  SERIAL_WRITE1 :              0E956 C |
 STR_DISC_SETUP :             0E930 C | *TARGET :                     "Z80" - |
*TIME :               "22\-026\-103\-12624\-027\-120\-12204\-025\-089\-110" - |
*TRUE :                           1 - |  UARTRC :                        21 - |
 UARTRD :                        20 - | *VERSION :                     142F - |
*Z80SYNTAX :                      0 - |

     50 symbols
     31 unused symbols

 AS V1.42 Beta [Bld 180] - Source File PC8001-Serial.asm - Page 5 - 2021/04/17 22時24分04秒


  Code Pages:
  ----------

STANDARD (0 changed characters)

1 code page

0.00 seconds assembly time

    132 lines source file
      2 passes
      0 errors
      0 warnings
